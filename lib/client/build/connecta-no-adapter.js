"use strict";var MessageType={RTC:1,RTC_FAIL:2,MESSAGE:3},ProcessEvents={ON_CONNECTED:1,ON_CLIENT_CONNECTED:2,ON_CLIENT_DISCONNECTED:3,ON_EVENT_MESSAGE:4,ON_MESSAGE:5,ON_MESSAGE_TRANSFER:6,ON_RTC_FAIL_UPDATE:7},InternalEvents={REDIRECT:-1,CONNECTED:-2,SDP_DESCRIPTION:-3,ICE_CANDIDATE:-4,RTC_CONNECT:-5,RTC_DISCONNECT:-6,RTC_FALLBACK_LIST:-7,RTC_FALLBACK:-8,JOINED_ROOM:-9,JOIN_ROOM:-10,LEFT_ROOM:-11,PEER_RENAME:-12},ConnectaEvents={CONNECTED:"connected",DISCONNECTED:"disconnected",ROOM_CREATED:"roomCreated",ROOM_DELETED:"roomDeleted"},RootRoom="/";"undefined"!=typeof module&&module.exports&&(module.exports.MessageType=MessageType,module.exports.ProcessEvents=ProcessEvents,module.exports.InternalEvents=InternalEvents,module.exports.ConnectaEvents=ConnectaEvents,module.exports.RootRoom=RootRoom);var ConnectaPeer=function(e,n){var t=this,o={iceServers:[]};function s(e){null!=e.candidate&&t.onIceCandidate&&t.onIceCandidate(t,JSON.stringify({ice:e.candidate}))}function a(e){t._conn.setLocalDescription(e).then(function(){t.onDescription&&t.onDescription(t,JSON.stringify({sdp:t._conn.localDescription}))}).catch(c)}function r(e){t._conn&&("connected"==t._conn.iceConnectionState&&t.onConnected&&t.onConnected(t),"failed"!=t._conn.iceConnectionState&&"disconnected"!=t._conn.iceConnectionState||(t.onConnectionFail&&t.onConnectionFail(t),"offer"==t.type&&t.createOffer()),"closed"==t._conn.iceConnectionState&&(t.onClosed&&t.onClosed(t),t.dispose()))}function c(e){t.onError&&t.onError(e)}function i(e){t.remoteStream=e.stream,t.onRemoteStream&&t.onRemoteStream(t.remoteStream)}function l(e){t._data=e?e.channel:t._conn.createDataChannel("data"),t._data.onopen=function(){t.onChannelState&&t.onChannelState("open")},t._data.onmessage=function(e){t.onMessage&&t.onMessage(t,e.data)},t._data.onclose=function(e){t.onChannelState&&t.onChannelState("closed")},t._data.onerror=function(e){t.onError&&t.onError(e)}}t.id=e,t.type="",t._conn,t._data,t.remoteStream,this.createOffer=function(e){e=e||!1,t._conn&&(l(),t.type="offer",t._conn.createOffer({RtpDataChannels:!0,iceRestart:!0,offerToReceiveAudio:e,offerToReceiveVideo:e}).then(a).catch(c))},this.onServerMessage=function(e){t._conn&&(e.sdp&&t._conn.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){"offer"==e.sdp.type&&(t.type="answer",t._conn.createAnswer().then(a).catch(c))}).catch(c),e.ice&&t._conn.addIceCandidate(new RTCIceCandidate(e.ice)).catch(c))},this.init=function(){if(function(){if(n)for(var e=0;e<n.length;e++)o.iceServers.push({urls:"stun:"+n[e]})}(),!t._conn)try{t._conn=new RTCPeerConnection(o),t._conn.onicecandidate=s,t._conn.onaddstream=i,t._conn.oniceconnectionstatechange=r,t._conn.ondatachannel=l,t._conn.streamTracks=[]}catch(e){t.onClosed&&t.onClosed(t)}}};ConnectaPeer.prototype.send=function(e){this._data&&"open"==this._data.readyState&&this._data.send(e)},ConnectaPeer.prototype.updateStream=function(e,n){if(n=n||!0,this._conn){if(this._conn.streamTracks.length>0){var t=this._conn.streamTracks;if(t.length>0)for(var o=t.length-1;o>=0;o--)this._conn.removeTrack(t[o]);this._conn.streamTracks=[]}if(e){var s=e.getTracks();for(o=0;o<s.length;o++)this._conn.streamTracks.push(this._conn.addTrack(s[o],e))}1==n&&this.createOffer(this._conn.streamTracks.length>0)}},ConnectaPeer.prototype.isConnected=function(){return!(!this._conn||"connected"!=this._conn.iceConnectionState&&"completed"!=this._conn.iceConnectionState)},ConnectaPeer.prototype.dispose=function(){var e=this;if(e.remoteStream&&(t=e.remoteStream.getTracks()).length>0)for(var n=t.length-1;n>=0;n--)e.remoteStream.removeTrack(t[n]),t[n].stop();if(e._data&&(e._data.onmessage=null,e._data.close()),e._conn&&"closed"!=e._conn.iceConnectionState){var t;if(e._conn.streamTracks.length>0)if((t=e._conn.streamTracks).length>0)for(n=t.length-1;n>=0;n--)e._conn.removeTrack(t[n]);e._conn.onicecandidate=null,e._conn.onaddstream=null,e._conn.oniceconnectionstatechange=null,e._conn.ondatachannel=null,e._conn.close()}e._conn=null,e._data=null,e.remoteStream=null};var ConnectaSocket=function(e,n){var t=this;function o(){if(t._conn){if(1===t._conn.readyState)return;t._conn.close()}var e=t._redirectURL.length>0?t._redirectURL:t._url;t._conn=new WebSocket(e),t._conn.onerror=s,t._conn.onclose=a,t._conn.onmessage=r}function s(e){t.onError&&t.onError(e)}function a(e){t.onClose&&t.onClose(e),t._redirectURL="",t._conn.onopen=null,t._conn.onerror=null,t._conn.onclose=null,t._conn.onmessage=null,t._reconnect>0&&setTimeout(o,1e3*t._reconnect)}function r(e){var n=JSON.parse(e.data);switch(n.ev){case InternalEvents.REDIRECT:!function(e){t._redirectURL=e,t._conn&&(t._conn.onopen=null,t._conn.onerror=null,t._conn.onclose=null,t._conn.onmessage=null,t._conn.close());o()}(n.data);break;case InternalEvents.CONNECTED:t.id=n.data,t.onConnected&&t.onConnected(t.id);break;case InternalEvents.JOINED_ROOM:t.roomUsers=n.data.users,t.room=n.data.room,t.useRTC=n.data.useRTC,t.rtcFallback=n.data.rtcFallback,t.onJoinedRoom&&t.onJoinedRoom(t.room);break;case InternalEvents.JOIN_ROOM:t.roomUsers&&t.roomUsers.indexOf(n.data)<0&&t.roomUsers.push(n.data),t.onClientJoinedRoom&&t.onClientJoinedRoom(n.data);break;case InternalEvents.LEFT_ROOM:t.roomUsers&&t.roomUsers.indexOf(n.data)>=0&&t.roomUsers.splice(t.roomUsers.indexOf(n.data),1),t.onClientLeftRoom&&t.onClientLeftRoom(n.data);break;case InternalEvents.SDP_DESCRIPTION:t.onSDPDescription&&t.onSDPDescription(n.id,n.data);break;case InternalEvents.ICE_CANDIDATE:t.onIceCandidate&&t.onIceCandidate(n.id,n.data);break;case InternalEvents.RTC_FALLBACK_LIST:t.fallbackUsers=n.data;break;case InternalEvents.RTC_FALLBACK:t.onRTCFallback&&t.onRTCFallback(n.from,n.data);break;default:n.ev?t.onMessage&&t.onMessage(n):t.onRawMessage&&t.onRawMessage(n)}}this.id,this.roomUsers=[],this.fallbackUsers=0,this.room="",this.useRTC=!1,this.rtcFallback=!1,this._url=e,this._redirectURL="",this._reconnect="number"==typeof n&&n>0?n:0,this._conn,o()};ConnectaSocket.prototype.send=function(e,n){e&&this._conn&&1===this._conn.readyState&&(n=n||"",this._conn.send(n+e))},ConnectaSocket.prototype.sendICE=function(e,n){this.send(JSON.stringify({ev:InternalEvents.ICE_CANDIDATE,id:e,data:n}),MessageType.RTC)},ConnectaSocket.prototype.sendSDP=function(e,n){this.send(JSON.stringify({ev:InternalEvents.SDP_DESCRIPTION,id:e,data:n}),MessageType.RTC)},ConnectaSocket.prototype.sendRTCState=function(e,n){this.send(JSON.stringify({ev:1==e?InternalEvents.RTC_CONNECT:InternalEvents.RTC_DISCONNECT,id:n}),MessageType.RTC)},ConnectaSocket.prototype.sendFallback=function(e){this.fallbackUsers&&this.fallbackUsers>0&&e&&this.send(JSON.stringify({ev:InternalEvents.RTC_FALLBACK,from:this.id,data:e}),MessageType.RTC_FAIL)},ConnectaSocket.prototype.sendMessage=function(e,n){e&&n&&this.send(JSON.stringify({ev:e,data:n}),MessageType.MESSAGE)},ConnectaSocket.prototype.close=function(){this._reconnect=0,this._conn&&1===this._conn.readyState&&(this._conn.close(),this._conn=null)},ConnectaSocket.prototype.dispose=function(){this._conn&&(this._reconnect=0,this.id=null,this._url=null,this._conn.onopen=null,this._conn.onerror=null,this._conn.onclose=null,this._conn.onmessage=null,this.close())};var Connecta=function(e,n,t){var o=this;function s(e){return o.peers[e]?o.peers[e]:((s=new ConnectaPeer(n=e,t)).onIceCandidate=u,s.onDescription=p,s.onRemoteStream=d,s.onConnected=_,s.onMessage=m,s.onConnectionFail=C,s.onClosed=h,s.onError=E,o.peers[n]=s,s.init(),s);var n,s}function a(e){o.dispatchEvent("joinedRoom",e)}function r(e){o._servConn.useRTC&&(o.hasWebRTCSupport()?s(e).createOffer():o._servConn.sendRTCState(!1,e)),o.dispatchEvent("clientJoinedRoom",e)}function c(e){var n;o.removePeer((n=e,o.peers[n]?o.peers[n]:null)),o.dispatchEvent("clientLeftRoom",e)}function i(e,n){o.dispatchEvent("peerMessage",{message:n,id:e,fallback:!0})}function l(e){e.ev&&o.dispatchEvent(e.ev,e)}function d(e){o.dispatchEvent("remoteStream",e)}function _(e){o.localStream&&e.updateStream(o.localStream,!1),o._servConn.sendRTCState(!0,e.id),o.dispatchEvent("peerConnected",e.id)}function C(e){o._servConn.sendRTCState(!1,e.id),o.dispatchEvent("peerFailed",e.id)}function h(e){var n,t=e.id;o.removePeer(e),n=t,o._servConn.sendRTCState(!1,n),o.dispatchEvent("peerDisconnected",t)}function p(e,n){o._servConn.sendSDP(e.id,n)}function f(e,n){o._servConn.useRTC&&(o.hasWebRTCSupport()?s(e).onServerMessage(JSON.parse(n)):o._servConn.sendRTCState(!1,e))}function u(e,n){o._servConn.sendICE(e.id,n)}function v(e,n){o.hasWebRTCSupport()&&s(e).onServerMessage(JSON.parse(n))}function m(e,n){o.dispatchEvent("peerMessage",{message:n,id:e.id,fallback:!1})}function E(e){o.dispatchEvent("error",e)}this.id,this.room,this._url=e,this._reconnect=n||3,this._servConn,this._listeners={},this.peers={},this.localStream,this.hasMediaSupport=function(){return window.MediaStream},this.hasWebRTCSupport=function(){return window.RTCPeerConnection},o._servConn=new ConnectaSocket(o._url,o._reconnect),o._servConn.onConnected=function(e){o.id=e,o.dispatchEvent("connected")},o._servConn.onError=function(e){o.dispatchEvent("error",e)},o._servConn.onClose=function(e){o.dispatchEvent("close"),o.closePeers()},o._servConn.onJoinedRoom=a,o._servConn.onClientJoinedRoom=r,o._servConn.onClientLeftRoom=c,o._servConn.onSDPDescription=f,o._servConn.onIceCandidate=v,o._servConn.onRTCFallback=i,o._servConn.onMessage=l};Connecta.prototype.removePeer=function(e){e&&(this.peers[e.id]&&delete this.peers[e.id],e.dispose(),e=null)},Connecta.prototype.closePeers=function(){for(var e in this.peers)this.removePeer(this.peers[e])},Connecta.prototype.sendToPeers=function(e){for(var n in this.peers)this.peers[n].send(e);this._servConn.sendFallback(e)},Connecta.prototype.sendMessage=function(e,n){this._servConn.sendMessage(e,n)},Connecta.prototype.enableMedia=function(e,n){if(e=e||!1,n=n||!1,e||1==n){var t=this;t.disableMedia(!0,!0,!1),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia({audio:n,video:e}).then(function(e){t.localStream=e,t.dispatchEvent("localStream",e);for(var n in t.peers)t.peers[n].updateStream(t.localStream)}).catch(function(e){t.dispatchEvent("error",e)})}},Connecta.prototype.disableMedia=function(e,n,t){if(e=(e=e||!0)||!0,t=t||!0,this.localStream){var o;if(1==n)if((o=this.localStream.getAudioTracks()).length>0)for(var s=o.length-1;s>=0;s--)this.localStream.removeTrack(o[s]),o[s].stop();if(1==e)if((o=this.localStream.getVideoTracks()).length>0)for(s=o.length-1;s>=0;s--)this.localStream.removeTrack(o[s]),o[s].stop();if(0==this.localStream.getTracks().length&&(this.localStream=null),1==t)for(var a in peers)peers[a].updateStream()}},Connecta.prototype.addEventListener=function(e,n){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(n)},Connecta.prototype.removeEventListener=function(e,n){if(this._listeners[e])for(var t=this._listeners[e].length-1;t>=0;t--)if(this._listeners[e][t]===n)return void this._listeners[e].splice(t,1)},Connecta.prototype.removeListeners=function(e){this._listeners[e]&&(this._listeners[e]=[],delete this._listeners[e])},Connecta.prototype.dispatchEvent=function(e,n){if(this._listeners[e])for(var t=0;t<this._listeners[e].length;t++)this._listeners[e][t].call(this,n)},Connecta.prototype.dispose=function(){console.log(this),this.closePeers(),this.disableMedia(!0,!0,!1),this._servConn.dispose(),this.removeListeners(),this.id=null,this.room=null,this._url=null,this._reconnect=0,this._servConn=null,this._listeners=null,this.peers=null,this.localStream=null};