"use strict";var ByteType={None:0,Int8Array:1,Uint8Array:2,Int16Array:3,Uint16Array:4,Int32Array:5,Uint32Array:6,Float32Array:7,Float64Array:8},sliceArray=function(e,n,t){if(e.slice)return e.slice(n,t);if(n<t&&t<=e.length){for(var o=[],r=n;r<t;r++)o.push(e[r]);return o}},createTypedArray=function(e,n){var t=null;switch(e){case ByteType.Int8Array:t=new Int8Array(n);break;case ByteType.Uint8Array:t=new Uint8Array(n);break;case ByteType.Int16Array:t=new Int16Array(n);break;case ByteType.Uint16Array:t=new Uint16Array(n);break;case ByteType.Int32Array:t=new Int32Array(n);break;case ByteType.Uint32Array:t=new Uint32Array(n);break;case ByteType.Float32Array:t=new Float32Array(n);break;case ByteType.Float64Array:t=new Float64Array(n)}return t},bufferToArray=function(e,n){var t=null;switch(e){case ByteType.Int8Array:t=new Int8Array(n.slice(0,n.byteLength));break;case ByteType.Uint8Array:t=new Uint8Array(n.slice(0,n.byteLength));break;case ByteType.Int16Array:t=new Int16Array(n.slice(0,n.byteLength));break;case ByteType.Uint16Array:t=new Uint16Array(n.slice(0,n.byteLength));break;case ByteType.Int32Array:t=new Int32Array(n.slice(0,n.byteLength));break;case ByteType.Uint32Array:t=new Uint32Array(n.slice(0,n.byteLength));break;case ByteType.Float32Array:t=new Float32Array(n.slice(0,n.byteLength));break;case ByteType.Float64Array:t=new Float64Array(n.slice(0,n.byteLength))}return t};"undefined"!=typeof module&&module.exports&&(module.exports.sliceArray=sliceArray,module.exports.ByteType=ByteType,module.exports.createTypedArray=createTypedArray,module.exports.bufferToArray=bufferToArray);var MessageType={RTC:1,RTC_FAIL:2,MESSAGE:3},ProcessEvents={ON_CONNECTED:1,ON_CLIENT_CONNECTED:2,ON_CLIENT_DISCONNECTED:3,ON_EVENT_MESSAGE:4,ON_MESSAGE:5,ON_MESSAGE_TRANSFER:6,ON_RTC_FAIL_UPDATE:7},InternalEvents={REDIRECT:-1,CONNECTED:-2,SDP_DESCRIPTION:-3,ICE_CANDIDATE:-4,RTC_CONNECT:-5,RTC_DISCONNECT:-6,RTC_FALLBACK_LIST:-7,RTC_FALLBACK:-8,JOINED_ROOM:-9,USER_JOINED_ROOM:-10,LEFT_ROOM:-11,USER_LEFT_ROOM:-12,ROOM_PARAMS:-13},ConnectaEvents={CONNECTED:"connected",BEFORE_DISCONNECTED:"beforeDisconnected",DISCONNECTED:"disconnected",ROOM_CREATED:"roomCreated",ROOM_DELETED:"roomDeleted",EVENT_MESSAGE:"onEventMessage",RAW_MESSAGE:"onRawMessage",ON_BYTE_ARRAY:"onByteArray"},RootRoom="/";"undefined"!=typeof module&&module.exports&&(module.exports.MessageType=MessageType,module.exports.ProcessEvents=ProcessEvents,module.exports.InternalEvents=InternalEvents,module.exports.ConnectaEvents=ConnectaEvents,module.exports.RootRoom=RootRoom);var ConnectaPeer=function(e,n){var t=this,o={iceServers:[]};function r(e){null!=e.candidate&&t.onIceCandidate&&t.onIceCandidate(t,JSON.stringify({ice:e.candidate}))}function a(e){t._conn.setLocalDescription(e).then(function(){t.onDescription&&t.onDescription(t,JSON.stringify({sdp:t._conn.localDescription}))}).catch(i)}function s(e){t._conn&&("connected"==t._conn.iceConnectionState&&t.onConnected&&t.onConnected(t),"failed"!=t._conn.iceConnectionState&&"disconnected"!=t._conn.iceConnectionState||(t.onConnectionFail&&t.onConnectionFail(t),"offer"==t.type&&t.createOffer()),"closed"==t._conn.iceConnectionState&&(t.onClosed&&t.onClosed(t),t.dispose()))}function i(e){t.onError&&t.onError(e)}function c(e){t.remoteStream=e.stream,t.onRemoteStream&&t.onRemoteStream(t.remoteStream)}function l(e){t._data=e?e.channel:t._conn.createDataChannel("data"),t._data.onopen=function(){t._data&&"open"==t._data.readyState&&t.onChannelState&&t.onChannelState(t,"open")},t._data.onmessage=function(e){e.data instanceof ArrayBuffer?t.onBytesMessage&&t.onBytesMessage(t,e.data):t.onMessage&&(Number(e.data[0])==MessageType.MESSAGE?t.onMessage(t,JSON.parse(e.data.substring(1,e.data.length))):t.onMessage(t,e.data))},t._data.onclose=function(e){t.onChannelState&&t.onChannelState(t,"closed")},t._data.onerror=function(e){t.onError&&t.onError(e)}}t.id=e,t.type="",t._conn,t._data,t.remoteStream,this.createOffer=function(e){e=e||!1,t._conn&&(l(),t.type="offer",t._conn.createOffer({RtpDataChannels:!0,iceRestart:!0,offerToReceiveAudio:e,offerToReceiveVideo:e}).then(a).catch(i))},this.onServerMessage=function(e){t._conn&&(e.sdp&&t._conn.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){"offer"==e.sdp.type&&(t.type="answer",t._conn.createAnswer().then(a).catch(i))}).catch(i),e.ice&&t._conn.addIceCandidate(new RTCIceCandidate(e.ice)).catch(i))},this.init=function(){if(function(){if(n)for(var e=0;e<n.length;e++)o.iceServers.push({urls:"stun:"+n[e]})}(),!t._conn)try{t._conn=new RTCPeerConnection(o),t._conn.onicecandidate=r,t._conn.onaddstream=c,t._conn.oniceconnectionstatechange=s,t._conn.ondatachannel=l,t._conn.streamTracks=[]}catch(e){t.onClosed&&t.onClosed(t)}}};ConnectaPeer.prototype.send=function(e){this._data&&"open"==this._data.readyState&&this._data.send(e)},ConnectaPeer.prototype.sendMessage=function(e,n){this._data&&"open"==this._data.readyState&&this._data.send(MessageType.MESSAGE+JSON.stringify({ev:e,data:n}))},ConnectaPeer.prototype.updateStream=function(e,n){var t=this;if(n=n||!0,t._conn){if(0<t._conn.streamTracks.length){var o=t._conn.streamTracks;if(0<o.length)for(var r=o.length-1;0<=r;r--)t._conn.removeTrack(o[r]);t._conn.streamTracks=[]}if(e){var a=e.getTracks();for(r=0;r<a.length;r++)t._conn.streamTracks.push(t._conn.addTrack(a[r],e))}1==n&&t.createOffer(0<t._conn.streamTracks.length)}},ConnectaPeer.prototype.isConnected=function(){return!(!this._conn||"connected"!=this._conn.iceConnectionState&&"completed"!=this._conn.iceConnectionState)},ConnectaPeer.prototype.dispose=function(){var e=this;if(e.remoteStream&&0<(t=e.remoteStream.getTracks()).length)for(var n=t.length-1;0<=n;n--)e.remoteStream.removeTrack(t[n]),t[n].stop();if(e._data&&(e._data.onclose=null,e._data.onmessage=null,e._data.onerror=null,e._data.onopen=null,e._data.close()),e._conn&&"closed"!=e._conn.iceConnectionState){var t;if(0<e._conn.streamTracks.length)if(0<(t=e._conn.streamTracks).length)for(n=t.length-1;0<=n;n--)e._conn.removeTrack(t[n]);e._conn.onicecandidate=null,e._conn.onaddstream=null,e._conn.oniceconnectionstatechange=null,e._conn.ondatachannel=null,e._conn.close()}e._conn=null,e._data=null,e.remoteStream=null},"undefined"!=typeof module&&module.exports&&(module.exports.ConnectaPeer=ConnectaPeer);var ConnectaSocket=function(e,n,t){var o=this;function r(){if(o._conn){if(1===o._conn.readyState)return;o._conn.close()}var e=0<o._redirectURL.length?o._redirectURL:o._url;o._conn=new WebSocket(e),o._conn.binaryType="arraybuffer",o._conn.open=a,o._conn.onerror=s,o._conn.onclose=i,o._conn.onmessage=c}function a(e){}function s(e){o.onError&&o.onError(e)}function i(e){o.onClose&&o.onClose(e),o._redirectURL="",o._conn.onopen=null,o._conn.onerror=null,o._conn.onclose=null,o._conn.onmessage=null,0<o._reconnect&&setTimeout(r,1e3*o._reconnect)}function c(e){var n,t;e.data instanceof ArrayBuffer?(n=e.data,(t=bufferToArray(o.byteType,n))&&(t[t.length-1]==MessageType.RTC_FAIL&&1==o.rtcFallback&&1==o.useRTC?o.onRTCFallback&&o.onRTCFallback(t[t.length-2],t,!0):o.onBytesMessage&&o.onBytesMessage(t))):function(n){try{switch((n=o.encode?JSON.parse(atob(n)):JSON.parse(n)).ev){case InternalEvents.REDIRECT:!function(e){o._redirectURL=e,o._conn&&(o._conn.onopen=null,o._conn.onerror=null,o._conn.onclose=null,o._conn.onmessage=null,o._conn.close());r()}(n.data);break;case InternalEvents.CONNECTED:o.id=n.data,o.onConnected&&o.onConnected(o.id);break;case InternalEvents.JOINED_ROOM:o.roomUsers=n.data.users,o.room=n.data.room,o.params=n.data.params,o.rtcId=n.data.rtcId,o.useRTC=n.data.useRTC,o.rtcFallback=n.data.rtcFallback,o.byteType=n.data.byteType,o.onJoinedRoom&&o.onJoinedRoom(o.room,o.params);break;case InternalEvents.ROOM_PARAMS:o.params=n.data,o.onRoomUpdate&&o.onRoomUpdate(o.params);break;case InternalEvents.USER_JOINED_ROOM:if(o.roomUsers){for(var e=!1,t=0;t<o.roomUsers.length;t++)if(o.roomUsers[t].id==n.data.id){e=!0;break}0==e&&o.roomUsers.push(n.data)}o.onClientJoinedRoom&&o.onClientJoinedRoom(n.data.id);break;case InternalEvents.LEFT_ROOM:o.roomUsers&&(o.roomUsers=[]),o.onLeftRoom&&o.onLeftRoom();break;case InternalEvents.USER_LEFT_ROOM:if(o.roomUsers)for(var t=0;t<o.roomUsers.length;t++)if(o.roomUsers[t].id==n.data){o.roomUsers.splice(t,1);break}o.onClientLeftRoom&&o.onClientLeftRoom(n.data);break;case InternalEvents.SDP_DESCRIPTION:o.onSDPDescription&&o.onSDPDescription(n.id,n.rtcId,n.data);break;case InternalEvents.ICE_CANDIDATE:o.onIceCandidate&&o.onIceCandidate(n.id,n.data);break;case InternalEvents.RTC_FALLBACK_LIST:o.fallbackUsers=n.data;break;case InternalEvents.RTC_FALLBACK:o.onRTCFallback&&o.onRTCFallback(n.from,n.data,!1);break;default:n.ev?o.onMessage&&o.onMessage(n):o.onRawMessage&&o.onRawMessage(n)}}catch(e){o.onRawMessage&&o.onRawMessage(n)}}(e.data)}this.id,this.encode=!0===t,this.roomUsers=[],this.fallbackUsers=0,this.room="",this.rtcId=0,this.byteType=0,this.useRTC=!1,this.rtcFallback=!1,this._url=e,this._redirectURL="",this._reconnect="number"==typeof n&&0<n?n:0,this._conn,r()};ConnectaSocket.prototype.send=function(e,n){e&&this._conn&&1===this._conn.readyState&&(ArrayBuffer.isView(e)?this._conn.send(e):(n=n||"",this._conn.send(n+e)))},ConnectaSocket.prototype.sendICE=function(e,n){this.send(this.encode?btoa(JSON.stringify({ev:InternalEvents.ICE_CANDIDATE,id:e,data:n})):JSON.stringify({ev:InternalEvents.ICE_CANDIDATE,id:e,data:n}),MessageType.RTC)},ConnectaSocket.prototype.sendSDP=function(e,n){this.send(this.encode?btoa(JSON.stringify({ev:InternalEvents.SDP_DESCRIPTION,id:e,data:n})):JSON.stringify({ev:InternalEvents.SDP_DESCRIPTION,id:e,data:n}),MessageType.RTC)},ConnectaSocket.prototype.sendRTCState=function(e,n){this.send(this.encode?btoa(JSON.stringify({ev:1==e?InternalEvents.RTC_CONNECT:InternalEvents.RTC_DISCONNECT,id:n})):JSON.stringify({ev:1==e?InternalEvents.RTC_CONNECT:InternalEvents.RTC_DISCONNECT,id:n}),MessageType.RTC)},ConnectaSocket.prototype.sendFallback=function(e){1==this.rtcFallback&&this.fallbackUsers&&0<this.fallbackUsers&&e&&(ArrayBuffer.isView(e)?(e[e.length-2]=this.rtcId,e[e.length-1]=MessageType.RTC_FAIL,this.send(e)):this.send(this.encode?btoa(JSON.stringify({ev:InternalEvents.RTC_FALLBACK,from:this.rtcId,data:e})):JSON.stringify({ev:InternalEvents.RTC_FALLBACK,from:this.rtcId,data:e}),MessageType.RTC_FAIL))},ConnectaSocket.prototype.sendMessage=function(e,n){e&&n&&this.send(this.encode?btoa(JSON.stringify({ev:e,data:n})):JSON.stringify({ev:e,data:n}),MessageType.MESSAGE)},ConnectaSocket.prototype.close=function(){this._reconnect=0,this._conn&&1===this._conn.readyState&&(this._conn.close(),this._conn=null)},ConnectaSocket.prototype.dispose=function(){this._conn&&(this._reconnect=0,this.id=null,this._url=null,this._conn.onopen=null,this._conn.onerror=null,this._conn.onclose=null,this._conn.onmessage=null,this.close())},"undefined"!=typeof module&&module.exports&&(module.exports.ConnectaSocket=ConnectaSocket);var Connecta=function(e,n,o,t){var r=this;function a(e){return r.peers[e]?r.peers[e]:((t=new ConnectaPeer(n=e,o)).onIceCandidate=m,t.onDescription=v,t.onRemoteStream=h,t.onConnected=u,t.onMessage=S,t.onBytesMessage=R,t.onConnectionFail=f,t.onClosed=y,t.onError=g,t.onChannelState=_,(r.peers[n]=t).init(),t);var n,t}function s(e,n){r.dispatchEvent("joinedRoom",{id:e,props:n})}function i(e){r._servConn.useRTC&&(r.hasWebRTCSupport()?a(e).createOffer():r._servConn.sendRTCState(!1,e));r.dispatchEvent("clientJoinedRoom",e)}function c(){r.closePeers(),r.dispatchEvent("leftRoom",id)}function l(e){var n;r.removePeer((n=e,r.peers[n]?r.peers[n]:null)),r.dispatchEvent("clientLeftRoom",e)}function d(e,n,t){var o=function(e){for(var n=0;n<r._servConn.roomUsers.length;n++)if(r._servConn.roomUsers[n].rtcId==e)return r._servConn.roomUsers[n];return null}(e);o&&(1==t&&(n=sliceArray(n,0,n.length-2)),r.dispatchEvent("peerMessage",{message:n,id:o.id,rtc:o.rtcId,array:t,fallback:!0}))}function p(e){r.dispatchEvent("onByteArray",e)}function C(e){e.ev&&(r.dispatchEvent("onServerMessage",e),r.dispatchEvent(e.ev,e))}function h(e){r.dispatchEvent("remoteStream",e)}function _(e,n){"open"==n&&r.dispatchEvent("connectedToPeer",e)}function u(e){r.localStream&&e.updateStream(r.localStream,!1),r._servConn.sendRTCState(!0,e.id),r.dispatchEvent("peerConnected",e.id)}function f(e){r._servConn.sendRTCState(!1,e.id),r.dispatchEvent("peerFailed",e.id)}function y(e){var n,t=e.id;r.removePeer(e),n=t,r._servConn.sendRTCState(!1,n),r.dispatchEvent("peerDisconnected",t)}function v(e,n){r._servConn.sendSDP(e.id,n)}function T(e,n,t){if(r._servConn.useRTC)if(r.hasWebRTCSupport()){var o=a(e);o.rtcId=n,o.onServerMessage(JSON.parse(t))}else r._servConn.sendRTCState(!1,e)}function m(e,n){r._servConn.sendICE(e.id,n)}function E(e,n){r.hasWebRTCSupport()&&a(e).onServerMessage(JSON.parse(n))}function S(e,n){r.dispatchEvent("peerMessage",{message:n,id:e.id,rtc:e.rtcId,array:!1,fallback:!1})}function R(e,n){var t=bufferToArray(r._servConn.byteType,n);t&&(1==r._servConn.rtcFallback&&(t=t.slice(0,t.length-2)),r.dispatchEvent("peerMessage",{message:t,id:e.id,rtc:e.rtcId,array:!0,fallback:!1}))}function g(e){r.dispatchEvent("error",e)}this.id,this.room,this._encode=t,this._url=e,this._reconnect=n||3,this._servConn,this._listeners={},this.peers={},this.localStream,this.hasMediaSupport=function(){return window.MediaStream},this.hasWebRTCSupport=function(){return window.RTCPeerConnection},r._servConn=new ConnectaSocket(r._url,r._reconnect,r._encode),r._servConn.onConnected=function(e){r.id=e,r.dispatchEvent("connected")},r._servConn.onError=function(e){r.dispatchEvent("error",e)},r._servConn.onClose=function(e){r.dispatchEvent("close"),r.closePeers()},r._servConn.onJoinedRoom=s,r._servConn.onClientJoinedRoom=i,r._servConn.onLeftRoom=c,r._servConn.onClientLeftRoom=l,r._servConn.onSDPDescription=T,r._servConn.onIceCandidate=E,r._servConn.onRTCFallback=d,r._servConn.onMessage=C,r._servConn.onBytesMessage=p,window.addEventListener("beforeunload",function(e){r.dispose()})};Connecta.prototype.removePeer=function(e){e&&(this.peers[e.id]&&(this.peers[e.id].onIceCandidate=null,this.peers[e.id].onDescription=null,this.peers[e.id].onRemoteStream=null,this.peers[e.id].onConnected=null,this.peers[e.id].onMessage=null,this.peers[e.id].onBytesMessage=null,this.peers[e.id].onConnectionFail=null,this.peers[e.id].onClosed=null,this.peers[e.id].onError=null,this.peers[e.id].onChannelState=null,delete this.peers[e.id]),e.dispose(),e=null)},Connecta.prototype.closePeers=function(){for(var e in this.peers)this.removePeer(this.peers[e])},Connecta.prototype.sendToPeers=function(e){for(var n in this.peers)this.peers[n].send&&this.peers[n].send(e);this._servConn.sendFallback(e)},Connecta.prototype.sendMessageToPeers=function(e,n){var t=MessageType.MESSAGE+JSON.stringify({ev:e,data:n});for(var o in this.peers)this.peers[o].send&&this.peers[o].send(t);this._servConn.sendFallback(t)},Connecta.prototype.send=function(e){this._servConn.send(e)},Connecta.prototype.sendMessage=function(e,n){this._servConn.sendMessage(e,n)},Connecta.prototype.createArray=function(e){var n=createTypedArray(this._servConn.byteType,e+(1==this._servConn.useRTC&&1==this._servConn.rtcFallback?2:0));return n[n.length-2]=this._servConn.rtcId,n},Connecta.prototype.enableMedia=function(e,n){if(n=n||!1,(e=e||!1)||1==n){var t=this;t.disableMedia(!0,!0,!1),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia({audio:n,video:e}).then(function(e){for(var n in t.localStream=e,t.dispatchEvent("localStream",e),t.peers)t.peers[n].updateStream(t.localStream)}).catch(function(e){t.dispatchEvent("error",e)})}},Connecta.prototype.disableMedia=function(e,n,t){if(e=(e=e||!0)||!0,t=t||!0,this.localStream){var o,r=this;if(1==n)if(0<(o=r.localStream.getAudioTracks()).length)for(var a=o.length-1;0<=a;a--)r.localStream.removeTrack(o[a]),o[a].stop();if(1==e)if(0<(o=r.localStream.getVideoTracks()).length)for(a=o.length-1;0<=a;a--)r.localStream.removeTrack(o[a]),o[a].stop();if(0==r.localStream.getTracks().length&&(r.localStream=null),1==t)for(var s in peers)peers[s].updateStream()}},Connecta.prototype.addEventListener=function(e,n){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(n)},Connecta.prototype.removeEventListener=function(e,n){if(this._listeners[e])for(var t=this._listeners[e].length-1;0<=t;t--)if(this._listeners[e][t]===n)return void this._listeners[e].splice(t,1)},Connecta.prototype.removeListeners=function(e){this._listeners[e]&&(this._listeners[e]=[],delete this._listeners[e])},Connecta.prototype.dispatchEvent=function(e,n){if(this._listeners[e])for(var t=0;t<this._listeners[e].length;t++)this._listeners[e][t].call(this,n)},Connecta.prototype.dispose=function(){this.closePeers(),this.disableMedia(!0,!0,!1),this._servConn.dispose(),this.removeListeners(),this.id=null,this.room=null,this._url=null,this._reconnect=0,this._servConn=null,this._listeners=null,this.peers=null,this.localStream=null},Connecta.prototype.peerRTCId=function(){return this._servConn?this._servConn.rtcId:-1},"undefined"!=typeof module&&module.exports&&(module.exports.Connecta=Connecta);